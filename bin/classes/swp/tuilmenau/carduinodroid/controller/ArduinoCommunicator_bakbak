package swp.tuilmenau.carduinodroid.controller;

import java.util.Arrays;
import java.util.Calendar;
import java.util.HashMap;
import java.util.Iterator;

import android.app.Activity;
import android.app.PendingIntent;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.hardware.usb.UsbConstants;
import android.hardware.usb.UsbDevice;
import android.hardware.usb.UsbDeviceConnection;
import android.hardware.usb.UsbEndpoint;
import android.hardware.usb.UsbInterface;
import android.hardware.usb.UsbManager;
import android.os.Handler;
import android.os.Looper;
import android.os.Message;
import android.util.Log;
import android.widget.Toast;

public class ArduinoCommunicator {
	
	public Activity activity;
	
    private static final int ARDUINO_USB_VENDOR_ID = 0x2341;
    private static final int ARDUINO_UNO_USB_PRODUCT_ID = 0x01;
    private static final int ARDUINO_MEGA_2560_USB_PRODUCT_ID = 0x10;
    private static final int ARDUINO_MEGA_2560_R3_USB_PRODUCT_ID = 0x42;
    private static final int ARDUINO_UNO_R3_USB_PRODUCT_ID = 0x43;
    private static final int ARDUINO_MEGA_2560_ADK_R3_USB_PRODUCT_ID = 0x44;
    private static final int ARDUINO_MEGA_2560_ADK_USB_PRODUCT_ID = 0x3F;
    
    private final static String TAG = "ArduinoCommunicatorActivity";
	protected static final String ACTION_USB_PERMISSION = "swp.tuilmenau.carduinodroid.USB";

    private final static boolean DEBUG = true;
    
    final static String DATA_RECEIVED_READY_INTENT = "swp.carduinodroid.intent.action.DATA_RECEIVED_READY";
    final static String DATA_RECEIVED_EXTRA = "swp.carduinodroid.intent.extra.DATA_RECEIVED_EXTRA";
    final static String DATA_RECEIVED_INTENT = "swp.carduinodroid.intent.action.DATA_RECEIVED";
    final static String SEND_DATA_INTENT = "swp.carduinodroid.intent.action.SEND_DATA";
    final static String DATA_SENT_INTERNAL_INTENT = "swp.carduinodroid.internal.intent.action.DATA_SENT";
    final static String DATA_EXTRA = "swp.carduinodroid.intent.extra.DATA";
    
    private volatile UsbDevice mUsbDevice = null;
    private volatile UsbDeviceConnection mUsbConnection = null;
    private volatile UsbEndpoint mInUsbEndpoint = null;
    private volatile UsbEndpoint mOutUsbEndpoint = null;
    
    private SenderThread mSenderThread;
    
    public ArduinoCommunicator(Activity parentActivity){
    	activity = parentActivity;
    	
        IntentFilter filter = new IntentFilter();
        filter.addAction(ArduinoCommunicatorService.DATA_RECEIVED_INTENT);
        filter.addAction(ArduinoCommunicatorService.DATA_SENT_INTERNAL_INTENT);
        
        activity.getBaseContext().registerReceiver(mReceiver, filter);
    	
        findDevice();
        initDevice();
        resetReceivedData();
        startSenderThread();
        startReceiverThread();
    }
    
    private void findDevice() { 
        UsbManager usbManager = (UsbManager) activity.getSystemService(Context.USB_SERVICE);
        mUsbDevice = null;
        HashMap<String, UsbDevice> usbDeviceList = usbManager.getDeviceList();
        if (DEBUG) Log.d(TAG, "length: " + usbDeviceList.size());
        Iterator<UsbDevice> deviceIterator = usbDeviceList.values().iterator();
        while (deviceIterator.hasNext()) {
            UsbDevice tempUsbDevice = deviceIterator.next();

            // Print device information. If you think your device should be able
            // to communicate with this app, add it to accepted products below.
            if (DEBUG) Log.d(TAG, "VendorId: " + tempUsbDevice.getVendorId());
            if (DEBUG) Log.d(TAG, "ProductId: " + tempUsbDevice.getProductId());
            if (DEBUG) Log.d(TAG, "DeviceName: " + tempUsbDevice.getDeviceName());
            if (DEBUG) Log.d(TAG, "DeviceId: " + tempUsbDevice.getDeviceId());
            if (DEBUG) Log.d(TAG, "DeviceClass: " + tempUsbDevice.getDeviceClass());
            if (DEBUG) Log.d(TAG, "DeviceSubclass: " + tempUsbDevice.getDeviceSubclass());
            if (DEBUG) Log.d(TAG, "InterfaceCount: " + tempUsbDevice.getInterfaceCount());
            if (DEBUG) Log.d(TAG, "DeviceProtocol: " + tempUsbDevice.getDeviceProtocol());

            if (tempUsbDevice.getVendorId() == ARDUINO_USB_VENDOR_ID) {
                if (DEBUG) Log.i(TAG, "Arduino device found!");

                switch (tempUsbDevice.getProductId()) {
                case ARDUINO_UNO_USB_PRODUCT_ID:
//                    Toast.makeText(activity.getBaseContext(), "Arduino Uno " + "found", Toast.LENGTH_SHORT).show();
                	toast("Arduino Uno " + "found");
                    mUsbDevice = tempUsbDevice;
                    break;
                case ARDUINO_MEGA_2560_USB_PRODUCT_ID:
//                    Toast.makeText(activity.getBaseContext(), "Arduino Mega 2560 " + "found", Toast.LENGTH_SHORT).show();
                	toast("Arduino Mega 2560 " + "found");
                    mUsbDevice = tempUsbDevice;
                    break;
                case ARDUINO_MEGA_2560_R3_USB_PRODUCT_ID:
//                    Toast.makeText(activity.getBaseContext(), "Arduino Mega 2560 R3 " + "found", Toast.LENGTH_SHORT).show();
                	toast("Arduino Mega 2560 R3 " + "found");
                    mUsbDevice = tempUsbDevice;
                    break;
                case ARDUINO_UNO_R3_USB_PRODUCT_ID:
//                    Toast.makeText(activity.getBaseContext(), "Arduino Uno R3 " + "found", Toast.LENGTH_SHORT).show();
                	toast("Arduino Uno R3 " + "found");
                    mUsbDevice = tempUsbDevice;
                    break;
                case ARDUINO_MEGA_2560_ADK_R3_USB_PRODUCT_ID:
//                    Toast.makeText(activity.getBaseContext(), "Arduino Mega 2560 ADK R3 " + "found", Toast.LENGTH_SHORT).show();
                	toast("Arduino Mega 2560 ADK R3 " + "found");
                    mUsbDevice = tempUsbDevice;
                    break;
                case ARDUINO_MEGA_2560_ADK_USB_PRODUCT_ID:
//                    Toast.makeText(activity.getBaseContext(), "Arduino Mega 2560 ADK " + "found", Toast.LENGTH_SHORT).show();
                	toast("Arduino Mega 2560 ADK " + "found");
                    mUsbDevice = tempUsbDevice;
                    break;
                }
            }
        }

        if (mUsbDevice == null) {
            if (DEBUG) Log.i(TAG, "No device found!");
//            Toast.makeText(activity.getBaseContext(), "No Device found", Toast.LENGTH_LONG).show();
            toast("No Device found");
        } else {
            if (DEBUG) Log.i(TAG, "Device found!");
//            Intent startIntent = new Intent(activity.getApplicationContext(), ArduinoCommunicatorService.class);
//            PendingIntent pendingIntent = PendingIntent.getService(activity.getApplicationContext(), 0, startIntent, 0);
//            usbManager.requestPermission(usbDevice, pendingIntent);
        }
    }
    
    BroadcastReceiver mReceiver = new BroadcastReceiver() {

        private void handleTransferedData(Intent intent, boolean receiving) {
        	
        	if(receiving){
  //      		handleReceivedData(intent);
        	}     	
            
            final byte[] newTransferedData = intent.getByteArrayExtra(ArduinoCommunicatorService.DATA_EXTRA);
            if (DEBUG) Log.i(TAG, "data: " + newTransferedData.length + " \"" + new String(newTransferedData) + "\"");
        }

        @Override
        public void onReceive(Context context, Intent intent) {
            final String action = intent.getAction();
            if (DEBUG) Log.d(TAG, "onReceive() " + action);

            if (ArduinoCommunicatorService.DATA_RECEIVED_INTENT.equals(action)) {
                handleTransferedData(intent, true);
            } else if (ArduinoCommunicatorService.DATA_SENT_INTERNAL_INTENT.equals(action)) {
                handleTransferedData(intent, false);
            }
        }
    };

    byte[] msgBuffer = new byte[4096];   
    int msgLength;
    int totalLength;
	Calendar c = Calendar.getInstance(); 
	long lastReceiveTime ;
    
    private void resetReceivedData(){
    	Arrays.fill(msgBuffer, (byte) 0);
    	totalLength = 0;
    	msgLength = 0;
    	lastReceiveTime = System.currentTimeMillis();
    }
    
    private void handleReceivedData(byte[] inBuffer){
    	if(System.currentTimeMillis() - lastReceiveTime > 100){
    		resetReceivedData();
    	}
    	
//    	byte[] inBuffer;
//    	inBuffer = intent.getByteArrayExtra(ArduinoCommunicatorService.DATA_EXTRA);
    	if(inBuffer[0] < 0){
    		return;
    	}
    	int length = inBuffer.length;
    	if (totalLength == 0){
    		int protocolHeader = inBuffer[0];
        	int protocol = (protocolHeader & 0xC0) >> 6;
        	msgLength = (protocolHeader & 0x0F);
        	if(msgLength >= totalLength + length -1){
        		System.arraycopy(inBuffer, 1, msgBuffer, 0, length-1);
        	}
        	totalLength += length-1;
    	}else{
        	if(msgLength >= totalLength + length){
        		System.arraycopy(inBuffer, 0, msgBuffer, totalLength, length);
    			totalLength += length;
        	}     	
    	}
  	    
    	if(msgLength == totalLength){
            Intent dataReadyIntent = new Intent(DATA_RECEIVED_READY_INTENT);
            dataReadyIntent.putExtra(DATA_RECEIVED_EXTRA, msgBuffer);
            activity.sendBroadcast(dataReadyIntent);
            Log.d(TAG, new String(msgBuffer));
//            Toast.makeText(activity.getBaseContext(), new String(msgBuffer), Toast.LENGTH_LONG).show();
            toast(new String(msgBuffer));
    		resetReceivedData();
    	}
    	lastReceiveTime = System.currentTimeMillis();
    }
    
    public void send(byte[] data){    	
    	if(mUsbDevice != null){
//       	 	Intent intent = new Intent(ArduinoCommunicatorService.SEND_DATA_INTENT);
       	 	//byte[] buffer = {(byte) 0x42, 0x65, 0x66};
//       	 	intent.putExtra(ArduinoCommunicatorService.DATA_EXTRA, data);
//            activity.sendBroadcast(intent);
            mSenderThread.mHandler.obtainMessage(10, data).sendToTarget();
    	}
    }
    
    public boolean hasDevice(){
    	if(mUsbDevice != null)
    		return true;
    	else return false;
    }
    
    public void stop(){
    	activity.unregisterReceiver(mReceiver);
//    	activity.stopService(new Intent(activity.getApplicationContext(),ArduinoCommunicatorService.class));
//    	mSenderThread.stop();
    	mUsbDevice = null;
    }
    
    public void toast(final String msg){  	
		activity.runOnUiThread(new Runnable(){
		     public void run() {
		          // UI code goes here
		    	 Toast.makeText(activity.getBaseContext(), msg, Toast.LENGTH_SHORT).show();
		     }
		});
    }
    
    private void startReceiverThread() {
        new Thread("arduino_receiver") {
            @Override
			public void run() {
                byte[] inBuffer = new byte[4096];
                while(mUsbDevice != null && mUsbConnection != null && mInUsbEndpoint != null) {
                    if (DEBUG) Log.d(TAG, "calling bulkTransfer() in");
                      final int len = mUsbConnection.bulkTransfer(mInUsbEndpoint, inBuffer, inBuffer.length, 0);
//                    if (len > 0) {
//                        Intent intent = new Intent(DATA_RECEIVED_INTENT);
//                        byte[] buffer = new byte[len];
//                        System.arraycopy(inBuffer, 0, buffer, 0, len);
//                        intent.putExtra(DATA_EXTRA, buffer);
////                        sendBroadcast(intent);
//                        handler.obtainMessage(10, buffer).sendToTarget();
//                    } else {
//                        if (DEBUG) Log.i(TAG, "zero data read!");
//                    }
                }
                if (DEBUG) Log.d(TAG, "receiver thread stopped.");
            }
        }.start();
    }

    private void startSenderThread() {
        mSenderThread = new SenderThread("arduino_sender");
        mSenderThread.start();
    }

    private class SenderThread extends Thread {
        public Handler mHandler;

        public SenderThread(String string) {
            super(string);
        }

        @Override
		public void run() {

            Looper.prepare();

            mHandler = new Handler() {
                @Override
				public void handleMessage(Message msg) {
                    if (DEBUG) Log.i(TAG, "handleMessage() " + msg.what);
                    if (msg.what == 10) {
                        final byte[] dataToSend = (byte[]) msg.obj;

                        if (DEBUG) Log.d(TAG, "calling bulkTransfer() out");
                        final int len = mUsbConnection.bulkTransfer(mOutUsbEndpoint, dataToSend, dataToSend.length, 0);
                        if (DEBUG) Log.d(TAG, len + " of " + dataToSend.length + " sent.");
                        Intent sendIntent = new Intent(DATA_SENT_INTERNAL_INTENT);
                        sendIntent.putExtra(DATA_EXTRA, dataToSend);
 //                       sendBroadcast(sendIntent);
                    } else if (msg.what == 11) {
                        Looper.myLooper().quit();
                    }
                }
            };

            Looper.loop();
            if (DEBUG) Log.i(TAG, "sender thread stopped");
        }
    }
    
    Handler handler = new Handler(){
		@Override
		public void handleMessage(Message msg) {
			if(msg.what ==10){
				handleReceivedData((byte[])msg.obj);
			}
		}   	
    };
    
    private byte[] getLineEncoding(int baudRate) {
        final byte[] lineEncodingRequest = { (byte) 0x80, 0x25, 0x00, 0x00, 0x00, 0x00, 0x08 };
	    //Get the least significant byte of baudRate, 
	    //and put it in first byte of the array being sent
	    lineEncodingRequest[0] = (byte)(baudRate & 0xFF);

	    //Get the 2nd byte of baudRate,
	    //and put it in second byte of the array being sent
	    lineEncodingRequest[1] = (byte)((baudRate >> 8) & 0xFF);

	    //ibid, for 3rd byte (my guess, because you need at least 3 bytes
	    //to encode your 115200+ settings)
	    lineEncodingRequest[2] = (byte)((baudRate >> 16) & 0xFF);

	    return lineEncodingRequest;
    }

    private boolean initDevice() {
        UsbManager usbManager = (UsbManager) activity.getSystemService(Context.USB_SERVICE);
        PendingIntent pi = PendingIntent.getBroadcast(activity.getApplicationContext(), 0, new Intent(ACTION_USB_PERMISSION), 0);
        usbManager.requestPermission(mUsbDevice, pi);
        
        mUsbConnection = usbManager.openDevice(mUsbDevice);
        if (mUsbConnection == null) {
            if (DEBUG) Log.e(TAG, "Opening USB device failed!");
//           Toast.makeText(getBaseContext(), getString(R.string.opening_device_failed), Toast.LENGTH_LONG).show();
            return false;
        }
        UsbInterface usbInterface = mUsbDevice.getInterface(1);
        if (!mUsbConnection.claimInterface(usbInterface, true)) {
            if (DEBUG) Log.e(TAG, "Claiming interface failed!");
//            Toast.makeText(getBaseContext(), getString(R.string.claimning_interface_failed), Toast.LENGTH_LONG).show();
            mUsbConnection.close();
            return false;
        }

        // Arduino USB serial converter setup
        // Set control line state
        mUsbConnection.controlTransfer(0x21, 0x22, 0, 0, null, 0, 0);
        // Set line encoding.
        mUsbConnection.controlTransfer(0x21, 0x20, 0, 0, getLineEncoding(9600), 7, 0);

        for (int i = 0; i < usbInterface.getEndpointCount(); i++) {
            if (usbInterface.getEndpoint(i).getType() == UsbConstants.USB_ENDPOINT_XFER_BULK) {
                if (usbInterface.getEndpoint(i).getDirection() == UsbConstants.USB_DIR_IN) {
                    mInUsbEndpoint = usbInterface.getEndpoint(i);
                } else if (usbInterface.getEndpoint(i).getDirection() == UsbConstants.USB_DIR_OUT) {
                    mOutUsbEndpoint = usbInterface.getEndpoint(i);
                }
            }
        }

        if (mInUsbEndpoint == null) {
            if (DEBUG) Log.e(TAG, "No in endpoint found!");
//            Toast.makeText(getBaseContext(), getString(R.string.no_in_endpoint_found), Toast.LENGTH_LONG).show();
            mUsbConnection.close();
            return false;
        }

        if (mOutUsbEndpoint == null) {
            if (DEBUG) Log.e(TAG, "No out endpoint found!");
//            Toast.makeText(getBaseContext(), getString(R.string.no_out_endpoint_found), Toast.LENGTH_LONG).show();
            mUsbConnection.close();
            return false;
        }

        return true;
    }
}

